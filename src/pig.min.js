(function(global){"use strict";var optimizedResize=function(){var callbacks=[];var running=false;function resize(){if(!running){running=true;if(window.requestAnimationFrame){window.requestAnimationFrame(runCallbacks)}else{setTimeout(runCallbacks,66)}}}function runCallbacks(){callbacks.forEach(function(callback){callback()});running=false}return{add:function(callback){if(!callbacks.length){window.addEventListener("resize",resize)}callbacks.push(callback)},disable:function(){window.removeEventListener("resize",resize)},reEnable:function(){window.addEventListener("resize",resize)}}}();function _injectStyle(containerId,classPrefix,transitionSpeed){var css="#"+containerId+" {"+"  position: relative;"+"}"+"."+classPrefix+"-figure {"+"  background-color: #D5D5D5;"+"  overflow: hidden;"+"  left: 0;"+"  position: absolute;"+"  top: 0;"+"  margin: 0;"+"}"+"."+classPrefix+"-figure img {"+"  left: 0;"+"  position: absolute;"+"  top: 0;"+"  height: 100%;"+"  width: 100%;"+"  opacity: 0;"+"  transition: "+transitionSpeed/1e3+"s ease opacity;"+"  -webkit-transition: "+transitionSpeed/1e3+"s ease opacity;"+"}"+"."+classPrefix+"-figure img."+classPrefix+"-thumbnail {"+"  -webkit-filter: blur(30px);"+"  filter: blur(30px);"+"  left: auto;"+"  position: relative;"+"  width: auto;"+"}"+"."+classPrefix+"-figure img."+classPrefix+"-loaded {"+"  opacity: 1;"+"}";var head=document.head||document.getElementsByTagName("head")[0];var style=document.createElement("style");style.type="text/css";if(style.styleSheet){style.styleSheet.cssText=css}else{style.appendChild(document.createTextNode(css))}head.appendChild(style)}function _extend(obj1,obj2){for(var i in obj2){if(obj2.hasOwnProperty(i)){obj1[i]=obj2[i]}}}function _getOffsetTop(elem){var offsetTop=0;do{if(!isNaN(elem.offsetTop)){offsetTop+=elem.offsetTop}elem=elem.offsetParent}while(elem);return offsetTop}function Pig(imageData,options){this.inRAF=false;this.isTransitioning=false;this.minAspectRatioRequiresTransition=false;this.minAspectRatio=null;this.latestYOffset=0;this.lastWindowWidth=window.innerWidth;this.scrollDirection="down";this.visibleImages=[];this.settings={containerId:"pig",scroller:window,classPrefix:"pig",figureTagName:"figure",spaceBetweenImages:4,transitionSpeed:500,primaryImageBufferHeight:5e3,secondaryImageBufferHeight:300,thumbnailSize:20,urlForSize:function(filename,size){return"/img/"+size+"/"+filename},getMinAspectRatio:function(lastWindowWidth){if(lastWindowWidth<=640)return 2;else if(lastWindowWidth<=1280)return 4;else if(lastWindowWidth<=1920)return 5;return 6},getImageSize:function(lastWindowWidth){if(lastWindowWidth<=640)return 250;else if(lastWindowWidth<=1920)return 500;return 500}};_extend(this.settings,options||{});this.container=document.getElementById(this.settings.containerId);if(!this.container){console.error("Could not find element with ID "+this.settings.containerId)}this.scroller=this.settings.scroller;this.images=this._parseImageData(imageData);_injectStyle(this.settings.containerId,this.settings.classPrefix,this.settings.transitionSpeed);return this}Pig.prototype._getTransitionTimeout=function(){var transitionTimeoutScaleFactor=1.5;return this.settings.transitionSpeed*transitionTimeoutScaleFactor};Pig.prototype._getTransitionString=function(){if(this.isTransitioning){return this.settings.transitionSpeed/1e3+"s transform ease"}return"none"};Pig.prototype._recomputeMinAspectRatio=function(){var oldMinAspectRatio=this.minAspectRatio;this.minAspectRatio=this.settings.getMinAspectRatio(this.lastWindowWidth);if(oldMinAspectRatio!==null&&oldMinAspectRatio!==this.minAspectRatio)this.minAspectRatioRequiresTransition=true;else this.minAspectRatioRequiresTransition=false};Pig.prototype._parseImageData=function(imageData){var progressiveImages=[];imageData.forEach(function(image,index){var progressiveImage=new ProgressiveImage(image,index,this);progressiveImages.push(progressiveImage)}.bind(this));return progressiveImages};Pig.prototype._computeLayout=function(){var wrapperWidth=parseInt(this.container.clientWidth);var row=[];var translateX=0;var translateY=0;var rowAspectRatio=0;this._recomputeMinAspectRatio();if(!this.isTransitioning&&this.minAspectRatioRequiresTransition){this.isTransitioning=true;setTimeout(function(){this.isTransitioning=false},this._getTransitionTimeout())}var transition=this._getTransitionString();[].forEach.call(this.images,function(image,index){rowAspectRatio+=parseFloat(image.aspectRatio);row.push(image);if(rowAspectRatio>=this.minAspectRatio||index+1===this.images.length){rowAspectRatio=Math.max(rowAspectRatio,this.minAspectRatio);var totalDesiredWidthOfImages=wrapperWidth-this.settings.spaceBetweenImages*(row.length-1);var rowHeight=totalDesiredWidthOfImages/rowAspectRatio;row.forEach(function(img){var imageWidth=rowHeight*img.aspectRatio;img.style={width:parseInt(imageWidth),height:parseInt(rowHeight),translateX:translateX,translateY:translateY,transition:transition};translateX+=imageWidth+this.settings.spaceBetweenImages}.bind(this));row=[];rowAspectRatio=0;translateY+=parseInt(rowHeight)+this.settings.spaceBetweenImages;translateX=0}}.bind(this));this.totalHeight=translateY-this.settings.spaceBetweenImages};Pig.prototype._doLayout=function(){this.container.style.height=this.totalHeight+"px";var bufferTop=this.scrollDirection==="up"?this.settings.primaryImageBufferHeight:this.settings.secondaryImageBufferHeight;var bufferBottom=this.scrollDirection==="down"?this.settings.primaryImageBufferHeight:this.settings.secondaryImageBufferHeight;var containerOffset=_getOffsetTop(this.container);var scrollerHeight=this.scroller===window?window.innerHeight:this.scroller.offsetHeight;var minTranslateYPlusHeight=this.latestYOffset-containerOffset-bufferTop;var maxTranslateY=this.latestYOffset-containerOffset+scrollerHeight+bufferBottom;this.images.forEach(function(image){if(image.style.translateY+image.style.height<minTranslateYPlusHeight||image.style.translateY>maxTranslateY){image.hide()}else{image.load(image.index)}}.bind(this))};Pig.prototype._getOnScroll=function(){var _this=this;var onScroll=function(){var newYOffset=_this.scroller===window?window.pageYOffset:_this.scroller.scrollTop;_this.previousYOffset=_this.latestYOffset||newYOffset;_this.latestYOffset=newYOffset;_this.scrollDirection=_this.latestYOffset>=_this.previousYOffset?"down":"up";if(!_this.inRAF){_this.inRAF=true;window.requestAnimationFrame(function(){_this._doLayout();_this.inRAF=false})}};return onScroll};Pig.prototype.enable=function(){this.onScroll=this._getOnScroll();this.scroller.addEventListener("scroll",this.onScroll);this.onScroll();this._computeLayout();this._doLayout();optimizedResize.add(function(){this.lastWindowWidth=this.scroller===window?window.innerWidth:this.scroller.offsetWidth;this._computeLayout();this._doLayout()}.bind(this));return this};Pig.prototype.disable=function(){this.scroller.removeEventListener("scroll",this.onScroll);optimizedResize.disable();return this};function ProgressiveImage(singleImageData,index,pig){this.existsOnPage=false;this.aspectRatio=singleImageData.aspectRatio;this.filename=singleImageData.filename;this.index=index;this.pig=pig;this.classNames={figure:pig.settings.classPrefix+"-figure",thumbnail:pig.settings.classPrefix+"-thumbnail",loaded:pig.settings.classPrefix+"-loaded"};return this}ProgressiveImage.prototype.load=function(indeximg){this.existsOnPage=true;this._updateStyles();this.pig.container.appendChild(this.getElement());setTimeout(function(){if(!this.existsOnPage){return}if(!this.href){this.href=document.createElement("a");this.href.setAttribute("data-fancybox-trigger","photo3");this.href.setAttribute("data-fancybox-index",indeximg);this.getElement().appendChild(this.href)}if(!this.thumbnail){this.thumbnail=new Image;this.thumbnail.src=this.pig.settings.urlForSize(this.filename,this.pig.settings.thumbnailSize);this.thumbnail.className=this.classNames.thumbnail;this.thumbnail.onload=function(){if(this.thumbnail){this.thumbnail.className+=" "+this.classNames.loaded}}.bind(this);this.href.appendChild(this.thumbnail)}if(!this.fullImage){this.fullImage=new Image;this.fullImage.src=this.pig.settings.urlForSize(this.filename,this.pig.settings.getImageSize(this.pig.lastWindowWidth));this.fullImage.onload=function(){if(this.fullImage){this.fullImage.className+=" "+this.classNames.loaded}}.bind(this);this.href.appendChild(this.fullImage)}}.bind(this),100)};ProgressiveImage.prototype.hide=function(){if(this.getElement()){if(this.thumbnail){this.thumbnail.src="";this.getElement().firstChild.removeChild(this.thumbnail);delete this.thumbnail}if(this.fullImage){this.fullImage.src="";this.getElement().firstChild.removeChild(this.fullImage);delete this.fullImage}if(this.href){this.getElement().removeChild(this.href);delete this.href}}if(this.existsOnPage){this.pig.container.removeChild(this.getElement())}this.existsOnPage=false};ProgressiveImage.prototype.getElement=function(){if(!this.element){this.element=document.createElement(this.pig.settings.figureTagName);this.element.className=this.classNames.figure;this._updateStyles()}return this.element};ProgressiveImage.prototype._updateStyles=function(){this.getElement().style.transition=this.style.transition;this.getElement().style.width=this.style.width+"px";this.getElement().style.height=this.style.height+"px";this.getElement().style.transform="translate3d("+this.style.translateX+"px,"+this.style.translateY+"px, 0)"};if(typeof define==="function"&&define.amd){define([],function(){return Pig})}else if(typeof module!=="undefined"&&module.exports){module.exports=Pig}else{global.Pig=Pig}})(typeof window!=="undefined"?window:this);
